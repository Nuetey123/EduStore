<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EduStore | Sales Dashboard</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Select2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

   <!-- ‚úÖ ADD THIS LINE (jQuery) -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <!-- Select2 JS (needs jQuery to work) -->
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


  <!-- Custom CSS -->
  <link rel="stylesheet" href="../css/sales-dashboard.css">
</head>
<body>
  <div class="d-flex">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">EduStore</div>
      <nav>
        <a href="#" class="active">üè† Dashboard</a>
        <a href="#">‚ûï New Sale</a>
        <a href="#">üßæ Transactions</a>
        <a href="#">üë§ Profile</a>
        <a href="#" id="logoutBtn">üö™ Logout</a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-grow-1">
      <!-- Topbar -->
      <header class="topbar d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <button class="menu-toggle">‚ò∞</button>
          <h1 class="h5 mb-0 ms-2">Sales Dashboard</h1>
        </div>
        <span id="currentUser" class="text-muted small ms-3">Loading...</span>
      </header>

      <div class="container-fluid p-3">
        <!-- Stats Cards -->
        <section class="stats">
          <div class="card">
            <h2>üìò Books Sold Today</h2>
            <p id="booksSold">0</p>
          </div>
          <div class="card">
            <h2>üë©‚Äçüéì Students Served</h2>
            <p id="studentsServed">0</p>
          </div>
          <div class="card">
            <h2>üíµ Sales Today</h2>
            <p class="sales-amount" id="salesToday">‚Çµ0</p>
          </div>
          <!-- ‚úÖ Low Stock Card ‚Äî Improved Layout -->
          <div class="col-12 col-md-6 col-lg-4">
            <div class="card shadow-sm p-3" style="min-height: 200px;">
              <h2 class="h6 text-center mb-3">‚ö†Ô∏è Low Stock</h2>
              <div id="lowStockList" class="text-center" style="overflow-y: auto; max-height: 300px; padding: 0 10px;">
                <!-- Books will appear here -->
              </div>
            </div>
          </div>
        </section>
        
        

        <div class="row g-3">
          <!-- New Sale Form -->
          <section class="sale-form col-12 col-lg-6">
            <div class="card shadow-sm p-3">
              <h2 class="h5 mb-3">‚ûï New Student Sale</h2>
              <form id="saleForm">
                <div class="mb-3">
                  <label for="studentName" class="form-label">Student Name</label>
                  <input type="text" id="studentName" class="form-control" placeholder="Enter student name" required>
                </div>

                <div class="mb-3">
                  <label for="studentClass" class="form-label">Class</label>
                  <input type="text" id="studentClass" class="form-control" placeholder="e.g., Primary 4" required>
                </div>

                <!-- Books Row (UNCHANGED) -->
                <div class="row g-2 align-items-end mb-3">
                  <div class="col-12 col-md-6">
                    <label for="book" class="form-label">Select Book</label>
                    <select id="book" class="form-select">
                      <option value="">-- Choose Book --</option>
                    </select>
                  </div>
                  
                  <div class="col-6 col-md-3">
                    <label for="quantity" class="form-label">Quantity</label>
                    <input type="number" id="quantity" class="form-control" min="1" value="1" max="1">
                    <small class="text-muted" id="availableStock">0 available in stock</small>
                  </div>
                  
                  <div class="col-6 col-md-3">
                    <button type="button" id="addBook" class="btn btn-primary w-100">‚ûï Add</button>
                  </div>
                </div>

                
                <h3 class="h6">üõí Cart</h3>
                <div class="table-responsive">
                  <table class="table table-bordered table-sm" id="cartTable">
                    <thead class="table-light">
                      <tr>
                        <th>Book</th>
                        <th>Qty</th>
                        <th>Price</th>
                        <th>Subtotal</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>

                <div class="text-end fw-bold mb-3">
                  Total: ‚Çµ<span id="grandTotal">0</span>
                </div>

                <button type="submit" class="btn btn-success w-100">üíæ Save & Print</button>
              </form>
            </div>
          </section>

          <!-- Transactions -->
          <section class="transactions col-12 col-lg-6">
            <div class="card shadow-sm p-3">
              <h2 class="h5 mb-3">üßæ Recent Transactions</h2>
              
              <!-- ‚úÖ Add Search Box -->
              <div class="mb-3">
                <input 
                  type="text" 
                  id="studentSearch" 
                  class="form-control" 
                  placeholder="Search by student name..."
                >
              </div>
          
              <div class="table-responsive">
                <table class="table table-striped table-hover">
                  <thead>
                    <tr>
                      <th>Student</th>
                      <th>Class</th>
                      <th>Books</th>
                      <th>Total</th>
                      <th>Date</th>
                      
                    </tr>
                  </thead>
                  <tbody id="transactionTable">
                    <!-- Recent sales will load here -->
                  </tbody>
                </table>
              </div>
            </div>
          </section>
        </div>
      </div>
    </main>
  </div>

 <script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  
  const SUPABASE_URL = "https://uyqpvhcjsflogujbfheu.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV5cXB2aGNqc2Zsb2d1amJmaGV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5MTQ4NzQsImV4cCI6MjA3MjQ5MDg3NH0.Yn75_sNjk8-bZhvFRyGZML3rLWro0W4tsBXhdcE6aDA";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let cashierFirstName = "";
let cashierLastName = "";

async function loadCashierInfo() {
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    console.error("No user logged in");
    return;
  }

  const { data: cashier, error } = await supabase
    .from("cashiers")
    .select("cashier_first_name, cashier_last_name")
    .eq("user_id", user.id)
    .single();

  if (error) {
    console.error("Error loading cashier:", error.message);
    return;
  }

  cashierFirstName = cashier.cashier_first_name || "";
  cashierLastName = cashier.cashier_last_name || "";
}

  // Declare the variable to track auth initialization
  let isAuthInitialized = false;

// DEBUG: Add this right after you get the user
const { data: { user } } = await supabase.auth.getUser();
console.log("üîç DEBUG USER METADATA:", user?.user_metadata);
console.log("üîë must_change_password =", user?.user_metadata?.must_change_password);
console.log("typeof =", typeof user?.user_metadata?.must_change_password);

  // ----------------- Auto-redirect if not logged in -----------------
  supabase.auth.onAuthStateChange(async (event, session) => {
    if (event === "SIGNED_OUT") {
      window.location.href = "sales-login.html";
    }
  });
     // ‚úÖ Helper to get current cashier details
async function getCurrentCashier() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return null;

  const { data: cashier, error } = await supabase
    .from('cashiers')
    .select('cashier_first_name, cashier_last_name')
    .eq('user_id', user.id)
    .single();

  if (error || !cashier) return null;

  return cashier;
}

  // Function to update the logged-in user display
  async function updateCurrentUserDisplay() {
  if (!isAuthInitialized) return;

  const { data: { user } } = await supabase.auth.getUser();
  const userEl = document.getElementById("currentUser");

  if (user) {
    const { data: cashier, error } = await supabase
      .from('cashiers')
      .select('cashier_first_name, cashier_last_name')
      .eq('user_id', user.id)
      .single();

    let displayName = "User";
    if (!error && cashier) {
      cashierFirstName = cashier.cashier_first_name || "";
      cashierLastName = cashier.cashier_last_name || "";
      displayName = `${cashierFirstName} ${cashierLastName}`.trim();
    } else {
      displayName = user.email.split('@')[0];
    }

    userEl.textContent = `Logged in as: ${displayName}`;
    userEl.style.display = "inline";
  } else {
    userEl.textContent = "Not logged in";
    userEl.style.display = "inline";
    window.location.href = "sales-login.html";
  }
}




  // ----------------- Initialize Auth and User Display -----------------
  async function initializeAuth() {
    const { data: { session }, error } = await supabase.auth.getSession();

    isAuthInitialized = true;
    
    if (!session) {
      window.location.href = "sales-login.html";
      return;
    }

    const { data: { user } } = await supabase.auth.getUser();
    
    // Check if user needs to change password
    if (user && user.user_metadata?.must_change_password) {
      window.location.href = 'sales-change-password.html';
      return;
    }

    // Update user display if no password change required
    updateCurrentUserDisplay();

    // Set up auth state listener
    supabase.auth.onAuthStateChange(async (event, session) => {
      if (event === "SIGNED_OUT") {
        window.location.href = "sales-login.html";
      } else if (event === "SIGNED_IN" && session) {
        const { data: { user } } = await supabase.auth.getUser();
        if (user && user.user_metadata?.must_change_password) {
          window.location.href = 'sales-change-password.html';
        } else {
          updateCurrentUserDisplay();
        }
      }
    });
  }

  // Initialize auth when page loads
  initializeAuth();

  // ----------------- Sidebar Toggle -----------------
  const menuBtn = document.querySelector(".menu-toggle");
  const sidebar = document.querySelector(".sidebar");
  menuBtn.addEventListener("click", () => sidebar.classList.toggle("show")); 

  // ----------------- Select2 & Load Books -----------------
  let bookPrices = {};
  let bookStock = {};
  let bookTitles = {};
  

  $(document).ready(async function() {
    $('#book').select2({ 
      placeholder: "Search ", 
      allowClear: true, 
      width: '100%',
      language: {
        noResults: () => "No books found. Try another search."
      }
    });

    // Fetch ALL books
    const { data, error } = await supabase.from('books').select('*').order('title');
    if (!error) {
      bookPrices = {};
      bookStock = {};
      bookTitles = {};

      const initialBooks = data.slice(0, 5);
      const otherBooks = data.slice(5);

      initialBooks.forEach(book => {
        const optionText = `${book.title} - ‚Çµ${book.selling_price}`;
        $('#book').append(`<option value="${book.id}">${optionText}</option>`);
        bookPrices[book.id] = book.selling_price;
        bookStock[book.id] = book.quantity;
      });

      otherBooks.forEach(book => {
        const optionText = `${book.title} - ‚Çµ${book.selling_price}`;
        $('#book').append(`<option value="${book.id}">${optionText}</option>`);
        bookPrices[book.id] = book.selling_price;
        bookStock[book.id] = book.quantity;
      });

      $('#book').trigger('change');
    } else {
      console.error("Error loading books:", error);
    }
  });  

  // ----------------- Stock Display (Books) -----------------
  $('#book').on('change', function() {
    const bookId = $(this).val();
    const qtyInput = document.getElementById('quantity');
    const stockSpan = document.getElementById('availableStock');
    if (bookId && bookStock[bookId] !== undefined) {
      const available = bookStock[bookId];
      stockSpan.textContent = `${available} In stock`;
      qtyInput.setAttribute('max', available);
      qtyInput.value = available > 0 ? 1 : 0;
      qtyInput.disabled = available === 0;
      document.getElementById('addBook').disabled = available === 0;
    } else {
      stockSpan.textContent = '0 ';
      qtyInput.removeAttribute('max');
    }
  });

  // ----------------- Cart Logic -----------------
  const addBookBtn = document.getElementById("addBook");
  const cartTableBody = document.querySelector("#cartTable tbody");
  const grandTotalEl = document.getElementById("grandTotal");

  function recalcTotal() {
    let total = 0;
    document.querySelectorAll("#cartTable tbody tr").forEach(row => {
      total += parseFloat(row.querySelector(".subtotal").textContent.replace("‚Çµ","")) || 0;
    });
    grandTotalEl.textContent = total.toFixed(2);
  }

  function addToCart(id, title, qty, price, stockObj) {
    const subtotal = price * qty;
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${title}</td>
      <td>
        <input type="number" class="form-control form-control-sm qty-input" 
               value="${qty}" min="1" max="${stockObj[id]}" 
               data-book-id="${id}">
      </td>
      <td>‚Çµ${price.toFixed(2)}</td>
      <td class="subtotal">‚Çµ${subtotal.toFixed(2)}</td>
      <td><button class="btn btn-sm btn-danger remove">‚ùå</button></td>
    `;

    row.querySelector(".remove").addEventListener("click", () => {
      const qtyToReturn = parseInt(row.querySelector('.qty-input').value);
      stockObj[id] += qtyToReturn;
      row.remove();
      recalcTotal();
    });

    row.querySelector(".qty-input").addEventListener("input", (e) => {
      let currentQty = parseInt(e.target.value) || 1;
      if (currentQty < 1) currentQty = 1;
      if (currentQty > stockObj[id] + qty) {
        alert("Not enough stock!");
        e.target.value = qty;
        return;
      }
      stockObj[id] += (qty - currentQty);
      qty = currentQty;
      row.querySelector(".subtotal").textContent = `‚Çµ${(price * qty).toFixed(2)}`;
      recalcTotal();
    });

    stockObj[id] -= qty;
    cartTableBody.appendChild(row);
    recalcTotal();
  }

  addBookBtn.addEventListener("click", () => {
    const sel = document.getElementById("book");
    const qtyInput = document.getElementById("quantity");
    const id = sel.value;
    if (!id) return alert("Select a book!");
    addToCart(id, sel.selectedOptions[0].textContent.split(" - ‚Çµ")[0], parseInt(qtyInput.value), bookPrices[id], bookStock);
    $('#book').val(null).trigger('change');
  });

  // ----------------- Submit Sale Form -----------------
  const saleForm = document.getElementById("saleForm");
  saleForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const studentName = document.getElementById("studentName").value;
    const studentClass = document.getElementById("studentClass").value;
    const rows = [...cartTableBody.querySelectorAll("tr")];
    if (!rows.length) return alert("Cart is empty!");

    let totalAmount = 0;
    const saleItems = rows.map(row => {
      const qtyInput = row.querySelector(".qty-input");
      const qty = parseInt(qtyInput.value);
      const price = parseFloat(row.cells[2].textContent.replace("‚Çµ",""));
      const subtotal = qty * price;
      totalAmount += subtotal;
      const bookId = qtyInput.getAttribute("data-book-id");
      return {
        item_title: row.cells[0].textContent,
        item_type: "Book",
        quantity: qty,
        price, subtotal,
        book_id: bookId
      };
    });

    // Get cashier name from logged-in user
// Get cashier name from cashiers table using user.id
const { data: { user } } = await supabase.auth.getUser();
let cashierFirstName = "";
let cashierLastName = "";

if (user) {
  const { data: cashier, error } = await supabase
    .from('cashiers')
    .select('cashier_first_name, cashier_last_name')
    .eq('user_id', user.id)
    .single();

  if (!error && cashier) {
    cashierFirstName = cashier.cashier_first_name || "";
    cashierLastName = cashier.cashier_last_name || "";
  }
}


// Insert sale WITH cashier names
const { data: saleData, error: saleError } = await supabase.from("sales")
  .insert([{
    student_name: studentName,
    student_class: studentClass,
    total: totalAmount,
    cashier_first_name: cashierFirstName,
    cashier_last_name: cashierLastName
  }])
  .select();
    if (saleError) return alert("Error saving sale!");

    const saleId = saleData[0].id;

    const { error: itemsError } = await supabase.from("sale_items").insert(
      saleItems.map(i => ({
        sale_id: saleId, item_name: i.item_title,
        quantity: i.quantity, price: i.price, subtotal: i.subtotal
      }))
    );
    if (itemsError) return alert("Error saving items!");

    const promises = [];
    saleItems.forEach(i => {
      if (i.book_id) {
        promises.push(supabase.rpc("decrement_book_stock", { p_book_id: parseInt(i.book_id), p_decrement_by: i.quantity }));
      }
    });
    await Promise.all(promises);

    const { data: newBooks } = await supabase.from("books").select("*");
    if (newBooks) newBooks.forEach(b => bookStock[b.id] = b.quantity);

    // ‚úÖ CORRECTED LINE:
printReceipt(saleId, studentName, studentClass, saleItems, totalAmount, cashierFirstName, cashierLastName);

    cartTableBody.innerHTML = "";
    recalcTotal();
    saleForm.reset();
  });

  function printReceipt(saleId, studentName, studentClass, saleItems, totalAmount, cashierFirstName = "", cashierLastName = "") {
  const win = window.open('', '_blank', 'width=600,height=800');
  if (!win) {
    alert("Popup blocked! Please allow popups to print receipts.");
    return;
  }

  const date = new Date().toLocaleString();
  const currentMonth = new Date().getMonth() + 1;

  let term;
  if (currentMonth >= 9 && currentMonth <= 12) {
    term = "Term 1";
  } else if (currentMonth >= 1 && currentMonth <= 4) {
    term = "Term 2";
  } else if (currentMonth >= 5 && currentMonth <= 8) {
    term = "Term 3";
  } else {
    term = "‚Äî";
  }

  const displayName = (cashierFirstName || "") + " " + (cashierLastName || "");
  const trimmedName = displayName.trim() || "Cashier";

  let html = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Receipt</title>
      <style>
        body {
          font-family: 'Courier New', monospace;
          margin: 20px;
          padding: 0;
          font-size: 14px;
          line-height: 1.4;
        }
        .header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 15px;
          width: 100%;
        }
        .school-info {
          text-align: left;
          font-size: 16px;
          font-weight: bold;
        }
        .receipt-id {
          font-size: 14px;
          margin-top: 5px;
          font-weight: normal;
        }
        .right-column {
          text-align: right;
          font-size: 14px;
        }
        .student-info {
          text-align: center;
          margin: 10px 0;
          font-size: 14px;
        }
        table {
          width: 100%;
          border-collapse: collapse;
          margin: 15px 0;
          font-size: 14px;
          text-align: center;
        }
        th, td {
          border: 1px solid #000;
          padding: 8px;
        }
        th {
          background-color: #f5f5f5;
          font-weight: bold;
        }
        .total-row {
          font-weight: bold;
          text-align: right;
          padding: 8px;
          margin-top: 10px;
          border-top: 2px dashed #000;
        }
        .footer {
          margin-top: 40px;
          display: flex;
          justify-content: space-between;
          font-size: 14px;
        }
        @media print {
          body { padding: 10px; }
          .no-print { display: none !important; }
        }
      </style>
    </head>
    <body>

      <div class="header">
        <div style="flex-shrink: 0; padding-right: 15px;">
          <img 
            id="receipt-logo" 
            src="https://uyqpvhcjsflogujbfheu.supabase.co/storage/v1/object/public/image/logo.jpeg" 
            alt="Royal Charisma School Logo"
            style="width: 90px; height: 90px; object-fit: contain;"
            onerror="this.outerHTML = '<div style=&quot;width:90px;height:90px;background:#f9f9f9;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#aaa;border:1px dashed #ccc;&quot;>RC</div>';"
          />
        </div>
        <div class="school-info">
          Royal Charisma School<br>
          Atadeka<br>
          0244985338 / 0244754611<br>
          <span class="receipt-id">Receipt #${saleId}</span>
        </div>
        <div class="right-column">
          Date: ${date}<br>
          Term: ${term}
        </div>
      </div>

      <div class="student-info">
        Name: ${studentName} &nbsp;&nbsp;&nbsp;&nbsp;
        Class: ${studentClass}
      </div>

      <table>
        <thead>
          <tr>
            <th>Book Name</th>
            <th>Qty</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>`;

  saleItems.forEach(i => {
    html += `<tr>
      <td>${i.item_title}</td>
      <td>${i.quantity}</td>
      <td>‚Çµ${(i.subtotal || 0).toFixed(2)}</td>
    </tr>`;
  });

  html += `</tbody>
      </table>

      <div class="total-row">
        Grand Total: ‚Çµ${totalAmount.toFixed(2)}
      </div>

      <div class="footer">
        <span class="cashier">Cashier: ${trimmedName}</span>
        <span class="signature">
          <strong>Signature:</strong>&nbsp;
          <span style="border-bottom: 1px solid #000; width: 140px; display: inline-block; padding: 2px 0; text-align: center;">
          </span>
        </span>
      </div>

      <div class="text-center mt-3 no-print" style="margin-top: 20px;">
        <button onclick="window.print()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
          üñ® Print Receipt
        </button>
        <button onclick="window.close()" style="margin-left: 10px; padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
          ‚úï Close
        </button>
      </div>

    </body>
    </html>`;

  win.document.write(html);
  win.document.close();

  // Optional: Auto-print after a short delay (but don't auto-close!)
  setTimeout(() => {
    try {
      // Only auto-print if triggered by user action (may be blocked otherwise)
      // win.print(); // ‚Üê Comment this out if you want user to click "Print"
    } catch (e) {
      console.warn("Auto-print blocked. User must click Print button.");
    }
  }, 500);
}

  // ‚úÖ Fetch and display dashboard stats
  async function loadDashboardStats() {
    const todayStart = new Date();
    todayStart.setHours(0, 0, 0, 0);
    const todayEnd = new Date();
    todayEnd.setHours(23, 59, 59, 999);

    try {
      const { data: sales, error: salesError } = await supabase
        .from('sales')
        .select('id, total, student_name')
        .gte('created_at', todayStart.toISOString())
        .lte('created_at', todayEnd.toISOString());

      if (salesError) throw salesError;

      const saleIds = sales.map(s => s.id);
      let booksSold = 0;
      
      if (saleIds.length > 0) {
        const { data: saleItems, error: itemsError } = await supabase
          .from('sale_items')
          .select('quantity')
          .in('sale_id', saleIds);

        if (itemsError) throw itemsError;
        booksSold = saleItems.reduce((sum, item) => sum + item.quantity, 0);
      }

      const studentNames = [...new Set(sales.map(s => s.student_name))];
      const studentsServed = studentNames.length;
      const salesToday = sales.reduce((sum, sale) => sum + sale.total, 0);

      const { data: lowStockBooks, error: lowStockError } = await supabase
        .from('books')
        .select('title, quantity')
        .lte('quantity', 5)
        .order('quantity', { ascending: true });

      if (lowStockError) throw lowStockError;

      const lowStockContainer = document.getElementById('lowStockList');
      if (lowStockBooks.length === 0) {
        lowStockContainer.textContent = "All good üëç (no low stock)";
      } else {
        lowStockContainer.innerHTML = lowStockBooks
          .map(book => `<div>${book.title} (${book.quantity} left)</div>`)
          .join('');
      }

      document.getElementById('booksSold').textContent = booksSold;
      document.getElementById('studentsServed').textContent = studentsServed;
      document.getElementById('salesToday').textContent = `‚Çµ${salesToday.toFixed(2)}`;

    } catch (err) {
      console.error("Error loading dashboard stats:", err.message || err);
    }
  }

  loadDashboardStats();
  setInterval(loadDashboardStats, 30000);

  const salesChannel = supabase
    .channel('new-sales')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'sales' }, () => {
      loadDashboardStats();
    })
    .subscribe();

  const booksChannel = supabase
    .channel('book-stock-changes')
    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'books' }, () => {
      loadDashboardStats();
    })
    .subscribe();

  // ‚úÖ Load recent transactions (last 10)
  async function loadRecentTransactions() {
    try {
      const { data: sales, error: salesError } = await supabase
        .from('sales')
        .select('id, student_name, student_class, total, created_at')
        .order('created_at', { ascending: false })
        .limit(10);

      if (salesError) {
        console.error("‚ùå Sales query failed:", salesError.message);
        throw salesError;
      }

      if (!sales || sales.length === 0) {
        document.getElementById('transactionTable').innerHTML = `
          <tr><td colspan="5" class="text-center text-muted">No transactions yet</td></tr>
        `;
        window.allTransactions = [];
        return;
      }

      const enrichedSales = [];
      for (const sale of sales) {
        const { data: items, error: itemsError } = await supabase
          .from('sale_items')
          .select('item_name, quantity')
          .eq('sale_id', sale.id);

        if (itemsError) {
          console.error(`‚ö†Ô∏è Error fetching items for sale_id ${sale.id}:`, itemsError.message);
          sale.books = "‚Äî";
        } else if (!items || items.length === 0) {
          sale.books = "‚Äî";
        } else {
          sale.books = items.map(i => `${i.item_name} (x${i.quantity})`).join(', ');
        }

        enrichedSales.push(sale);
      }

      window.allTransactions = enrichedSales;
      displayTransactions(enrichedSales);

    } catch (err) {
      console.error("üí• Full error in loadRecentTransactions:", err);
      document.getElementById('transactionTable').innerHTML = `
        <tr>
          <td colspan="5" class="text-center text-danger">
            Failed to load transactions. Check console for details.
          </td>
        </tr>
      `;
    }
  }

  document.addEventListener('click', async (e) => {
    const button = e.target.closest('.js-reprint');
    if (!button) return;

    const saleIdStr = button.getAttribute('data-sale-id');
    if (!saleIdStr) {
      console.error("‚ùå Print button missing data-sale-id");
      return;
    }

    const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
    if (!uuidRegex.test(saleIdStr)) {
      console.error("‚ùå Invalid UUID format:", saleIdStr);
      alert("Invalid transaction ID. Please refresh the page.");
      return;
    }

    button.disabled = true;
    button.textContent = 'Printing...';

    try {
      await reprintTransaction(saleIdStr);
    } catch (err) {
      console.error("üí• Error during reprint:", err);
      alert("Failed to reprint receipt. Check console.");
    } finally {
      button.disabled = false;
      button.textContent = 'üñ® Print';
    }
  });

  async function reprintTransaction(saleId) {
    try {
      const { data: sale, error: saleError } = await supabase
        .from("sales")
        .select("id, student_name, student_class, total, created_at, cashier_first_name, cashier_last_name")
        .eq("id", saleId)
        .single();

      if (saleError) throw saleError;

      const { data: items, error: itemsError } = await supabase
        .from("sale_items")
        .select("item_name, quantity, subtotal")
        .eq("sale_id", saleId);

      if (itemsError) throw itemsError;

      const saleItems = items.map(i => ({
        item_title: i.item_name,
        quantity: i.quantity,
        subtotal: i.subtotal ?? 0
      }));

      printReceipt(
        sale.id,
        sale.student_name,
        sale.student_class,
        saleItems,
        sale.total,
        sale.cashier_first_name || "",
        sale.cashier_last_name || ""
      );

    } catch (err) {
      console.error("‚ùå Error reprinting receipt:", err.message || err);
      alert("Failed to reprint receipt. Check console.");
    }
  }

  document.getElementById('studentSearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase().trim();
    
    if (!window.allTransactions) return;

    const filtered = window.allTransactions.filter(sale => 
      sale.student_name.toLowerCase().includes(searchTerm)
    );

    displayTransactions(filtered);
  });

  function displayTransactions(transactions) {
    const table = document.getElementById("transactionTable");

    if (transactions.length === 0) {
      table.innerHTML = `
        <tr>
          <td colspan="6" class="text-center text-muted">No transactions found</td>
        </tr>
      `;
      return;
    }

    table.innerHTML = transactions
      .map(
        sale => `
          <tr>
            <td>${sale.student_name}</td>
            <td>${sale.student_class}</td>
            <td>${sale.books}</td>
            <td>‚Çµ${sale.total.toFixed(2)}</td>
            <td>${new Date(sale.created_at).toLocaleString()}</td>
            <td>
              <button 
                class="btn btn-sm btn-outline-secondary js-reprint" 
                data-sale-id="${sale.id}">
                üñ® Print
              </button>
            </td>
          </tr>
        `
      )
      .join('');
  }

  // ‚úÖ Load transactions initially and refresh every 30s
  loadRecentTransactions();
  setInterval(loadRecentTransactions, 30000);



  const newSalesChannel = supabase
    .channel('new-sales-realtime')
    .on(
      'postgres_changes',
      { event: 'INSERT', schema: 'public', table: 'sales' },
      () => {
        loadRecentTransactions();
        loadDashboardStats();
      }
    )
    .subscribe();

  // ----------------- Logout Functionality -----------------
  document.getElementById("logoutBtn").addEventListener("click", async (e) => {
    e.preventDefault();

    if (!confirm("Are you sure you want to log out?")) {
      return;
    }

    const statusEl = document.createElement("div");
    statusEl.className = "alert alert-info fixed-top text-center m-0 rounded-0";
    statusEl.textContent = "Signing out...";
    document.body.appendChild(statusEl);

    try {
      const { error } = await supabase.auth.signOut();
      
      if (error) {
        throw error;
      }

      localStorage.removeItem("lastUsedBookId");
      sessionStorage.clear();
      window.location.href = "sales-login.html";

    } catch (err) {
      console.error("Logout failed:", err);
      statusEl.className = "alert alert-danger fixed-top text-center m-0 rounded-0";
      statusEl.textContent = "‚ùå Failed to sign out. Try again.";
      setTimeout(() => {
        document.body.removeChild(statusEl);
      }, 3000);
    } finally {
      setTimeout(() => {
        if (statusEl.parentNode) {
          document.body.removeChild(statusEl);
        }
      }, 2000);
    }
  });

  // Fix the duplicate search listener
  // Remove this duplicate - it's already handled above
  // document.getElementById("studentSearch").addEventListener("input", function() {
  //   const query = this.value.toLowerCase();
  //   const rows = document.querySelectorAll("#transactionTable tr");
  //   rows.forEach(row => {
  //     const student = row.cells[0]?.textContent.toLowerCase();
  //     row.style.display = student && student.includes(query) ? "" : "none";
  //   });
  // });

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
