<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EduStore | Sales Dashboard</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Select2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="../css/sales-dashboard.css">
</head>
<body>
  <div class="d-flex">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">EduStore</div>
      <nav>
        <a href="#" class="active">üè† Dashboard</a>
        <a href="#">‚ûï New Sale</a>
        <a href="#">üßæ Transactions</a>
        <a href="#">üë§ Profile</a>
        <a href="#">üö™ Logout</a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-grow-1">
      <!-- Topbar -->
      <header class="topbar">
        <button class="menu-toggle">‚ò∞</button>
        <h1 class="h5 mb-0">Sales Dashboard</h1>
      </header>

      <div class="container-fluid p-3">
        <!-- Stats Cards -->
        <section class="stats">
          <div class="card">
            <h2>üìò Books Sold Today</h2>
            <p id="booksSold">0</p>
          </div>
          <div class="card">
            <h2>üë©‚Äçüéì Students Served</h2>
            <p id="studentsServed">0</p>
          </div>
          <div class="card">
            <h2>üíµ Sales Today</h2>
            <p class="sales-amount" id="salesToday">‚Çµ0</p>
          </div>
          <!-- ‚úÖ Low Stock Card ‚Äî Improved Layout -->
          <div class="col-12 col-md-6 col-lg-4">
            <div class="card shadow-sm p-3" style="min-height: 200px;">
              <h2 class="h6 text-center mb-3">‚ö†Ô∏è Low Stock</h2>
              <div id="lowStockList" class="text-center" style="overflow-y: auto; max-height: 300px; padding: 0 10px;">
                <!-- Books will appear here -->
              </div>
            </div>
          </div>
        </section>
        
        

        <div class="row g-3">
          <!-- New Sale Form -->
          <section class="sale-form col-12 col-lg-6">
            <div class="card shadow-sm p-3">
              <h2 class="h5 mb-3">‚ûï New Student Sale</h2>
              <form id="saleForm">
                <div class="mb-3">
                  <label for="studentName" class="form-label">Student Name</label>
                  <input type="text" id="studentName" class="form-control" placeholder="Enter student name" required>
                </div>

                <div class="mb-3">
                  <label for="studentClass" class="form-label">Class</label>
                  <input type="text" id="studentClass" class="form-control" placeholder="e.g., Primary 4" required>
                </div>

                <!-- Books Row (UNCHANGED) -->
                <div class="row g-2 align-items-end mb-3">
                  <div class="col-12 col-md-6">
                    <label for="book" class="form-label">Select Book</label>
                    <select id="book" class="form-select">
                      <option value="">-- Choose Book --</option>
                    </select>
                  </div>
                  
                  <div class="col-6 col-md-3">
                    <label for="quantity" class="form-label">Quantity</label>
                    <input type="number" id="quantity" class="form-control" min="1" value="1" max="1">
                    <small class="text-muted" id="availableStock">0 available in stock</small>
                  </div>
                  
                  <div class="col-6 col-md-3">
                    <button type="button" id="addBook" class="btn btn-primary w-100">‚ûï Add</button>
                  </div>
                </div>

                
                <h3 class="h6">üõí Cart</h3>
                <div class="table-responsive">
                  <table class="table table-bordered table-sm" id="cartTable">
                    <thead class="table-light">
                      <tr>
                        <th>Book</th>
                        <th>Qty</th>
                        <th>Price</th>
                        <th>Subtotal</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>

                <div class="text-end fw-bold mb-3">
                  Total: ‚Çµ<span id="grandTotal">0</span>
                </div>

                <button type="submit" class="btn btn-success w-100">üíæ Save & Print</button>
              </form>
            </div>
          </section>

          <!-- Transactions -->
          <section class="transactions col-12 col-lg-6">
            <div class="card shadow-sm p-3">
              <h2 class="h5 mb-3">üßæ Recent Transactions</h2>
              
              <!-- ‚úÖ Add Search Box -->
              <div class="mb-3">
                <input 
                  type="text" 
                  id="studentSearch" 
                  class="form-control" 
                  placeholder="Search by student name..."
                >
              </div>
          
              <div class="table-responsive">
                <table class="table table-striped table-hover">
                  <thead>
                    <tr>
                      <th>Student</th>
                      <th>Class</th>
                      <th>Books</th>
                      <th>Total</th>
                      <th>Date</th>
                    </tr>
                  </thead>
                  <tbody id="transactionTable">
                    <!-- Recent sales will load here -->
                  </tbody>
                </table>
              </div>
            </div>
          </section>
        </div>
      </div>
    </main>
  </div>

  <!-- jQuery (needed for Select2) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Select2 JS -->
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Supabase + JS Logic -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    
    const SUPABASE_URL = "https://uyqpvhcjsflogujbfheu.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV5cXB2aGNqc2Zsb2d1amJmaGV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5MTQ4NzQsImV4cCI6MjA3MjQ5MDg3NH0.Yn75_sNjk8-bZhvFRyGZML3rLWro0W4tsBXhdcE6aDA";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ----------------- Force Password Change Modal -----------------
const modal = document.getElementById("passwordModal");
const changeBtn = document.getElementById("changePasswordBtn");
const statusEl = document.getElementById("statusMessage");

// ‚úÖ Check user after login ‚Äî USE supabase, NOT client!
async function checkUser() {
  const { data: { user } } = await supabase.auth.getUser(); // ‚úÖ FIXED: supabase, not client
  if (user?.user_metadata?.must_change_password) {
    modal.style.display = "flex"; // üîπ Show popup
  }
}

// ‚úÖ Call checkUser when page loads
checkUser();

// ‚úÖ Handle password change
changeBtn.addEventListener("click", async () => {
  const newPassword = document.getElementById("newPassword").value;
  const confirmPassword = document.getElementById("confirmPassword").value;

  if (newPassword !== confirmPassword) {
    statusEl.textContent = "‚ùå Passwords do not match!";
    statusEl.style.color = "red";
    return;
  }

  changeBtn.disabled = true;
  statusEl.textContent = "Updating password...";
  statusEl.style.color = "blue";

  const { error } = await supabase.auth.updateUser({
    password: newPassword,
    data: { must_change_password: false } // ‚úÖ Update metadata to prevent loop
  });

  if (error) {
    statusEl.textContent = "‚ùå " + error.message;
    statusEl.style.color = "red";
    changeBtn.disabled = false;
  } else {
    statusEl.textContent = "‚úÖ Password updated! Reloading...";
    statusEl.style.color = "green";
    setTimeout(() => window.location.reload(), 1500);
  }
});

// ----------------- Sidebar Toggle -----------------
const menuBtn = document.querySelector(".menu-toggle");
const sidebar = document.querySelector(".sidebar");
menuBtn.addEventListener("click", () => sidebar.classList.toggle("show")); 


// ----------------- Select2 & Load Books -----------------
let bookPrices = {};  // üëà Changed from const to let
let bookStock = {};   // üëà Changed from const to let

$(document).ready(async function() {
  $('#book').select2({ 
    placeholder: "Search ", 
    allowClear: true, 
    width: '100%',
    language: {
      noResults: () => "No books found. Try another search."
    }
  });

  // Fetch ALL books
  const {  data, error } = await supabase.from('books').select('*').order('title');
  if (!error) {
    // Reset caches
    bookPrices = {};   // ‚úÖ Now allowed
    bookStock = {};    // ‚úÖ Now allowed

    // Split into first 5 and the rest
    const initialBooks = data.slice(0, 5);
    const otherBooks = data.slice(5);

    // Add first 5 books to dropdown
    initialBooks.forEach(book => {
      const optionText = `${book.title} - ‚Çµ${book.selling_price}`;
      $('#book').append(`<option value="${book.id}">${optionText}</option>`);
      bookPrices[book.id] = book.selling_price;
      bookStock[book.id] = book.quantity;
    });

    // Add remaining books ‚Äî searchable but not visible until typed
    otherBooks.forEach(book => {
      const optionText = `${book.title} - ‚Çµ${book.selling_price}`;
      $('#book').append(`<option value="${book.id}">${optionText}</option>`);
      bookPrices[book.id] = book.selling_price;
      bookStock[book.id] = book.quantity;
    });

    // üëá Optional: Refresh Select2 (usually not needed if initialized before)
    $('#book').trigger('change');
  } else {
    console.error("Error loading books:", error);
  }
});  

// ----------------- Stock Display (Books) -----------------
$('#book').on('change', function() {
  const bookId = $(this).val();
  const qtyInput = document.getElementById('quantity');
  const stockSpan = document.getElementById('availableStock');
  if (bookId && bookStock[bookId] !== undefined) {
    const available = bookStock[bookId];
    stockSpan.textContent = `${available} In stock`;
    qtyInput.setAttribute('max', available);
    qtyInput.value = available > 0 ? 1 : 0;
    qtyInput.disabled = available === 0;
    document.getElementById('addBook').disabled = available === 0;
  } else {
    stockSpan.textContent = '0 ';
    qtyInput.removeAttribute('max');
  }
});

// ----------------- Cart Logic -----------------
const addBookBtn = document.getElementById("addBook");
const cartTableBody = document.querySelector("#cartTable tbody");
const grandTotalEl = document.getElementById("grandTotal");

function recalcTotal() {
  let total = 0;
  document.querySelectorAll("#cartTable tbody tr").forEach(row => {
    total += parseFloat(row.querySelector(".subtotal").textContent.replace("‚Çµ","")) || 0;
  });
  grandTotalEl.textContent = total.toFixed(2);
}

function addToCart(id, title, qty, price, stockObj) {
  const subtotal = price * qty;
  const row = document.createElement("tr");
  row.innerHTML = `
    <td>${title}</td>
    <td>
      <input type="number" class="form-control form-control-sm qty-input" 
             value="${qty}" min="1" max="${stockObj[id]}" 
             data-book-id="${id}">
    </td>
    <td>‚Çµ${price.toFixed(2)}</td>
    <td class="subtotal">‚Çµ${subtotal.toFixed(2)}</td>
    <td><button class="btn btn-sm btn-danger remove">‚ùå</button></td>
  `;

  // Remove handler
  row.querySelector(".remove").addEventListener("click", () => {
    const qtyToReturn = parseInt(row.querySelector('.qty-input').value);
    stockObj[id] += qtyToReturn;
    row.remove();
    recalcTotal();
  });

  // Qty change handler
  row.querySelector(".qty-input").addEventListener("input", (e) => {
    let currentQty = parseInt(e.target.value) || 1;
    if (currentQty < 1) currentQty = 1;
    if (currentQty > stockObj[id] + qty) {
      alert("Not enough stock!");
      e.target.value = qty;
      return;
    }
    stockObj[id] += (qty - currentQty);
    qty = currentQty;
    row.querySelector(".subtotal").textContent = `‚Çµ${(price * qty).toFixed(2)}`;
    recalcTotal();
  });

  stockObj[id] -= qty;
  cartTableBody.appendChild(row);
  recalcTotal();
}

addBookBtn.addEventListener("click", () => {
  const sel = document.getElementById("book");
  const qtyInput = document.getElementById("quantity");
  const id = sel.value;
  if (!id) return alert("Select a book!");
  addToCart(id, sel.selectedOptions[0].textContent.split(" - ‚Çµ")[0], parseInt(qtyInput.value), bookPrices[id], bookStock);
  $('#book').val(null).trigger('change');
});

// ----------------- Submit Sale Form -----------------
const saleForm = document.getElementById("saleForm");
saleForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const studentName = document.getElementById("studentName").value;
  const studentClass = document.getElementById("studentClass").value;
  const rows = [...cartTableBody.querySelectorAll("tr")];
  if (!rows.length) return alert("Cart is empty!");

  let totalAmount = 0;
  const saleItems = rows.map(row => {
    const qtyInput = row.querySelector(".qty-input");
    const qty = parseInt(qtyInput.value);
    const price = parseFloat(row.cells[2].textContent.replace("‚Çµ",""));
    const subtotal = qty * price;
    totalAmount += subtotal;
    const bookId = qtyInput.getAttribute("data-book-id");
    return {
      item_title: row.cells[0].textContent,
      item_type: "Book",
      quantity: qty,
      price, subtotal,
      book_id: bookId
    };
  });

  // Insert sale
  const { data: saleData, error: saleError } = await supabase.from("sales")
    .insert([{ student_name: studentName, student_class: studentClass, total: totalAmount }])
    .select();
  if (saleError) return alert("Error saving sale!");

  const saleId = saleData[0].id;

  // Insert sale items
  const { error: itemsError } = await supabase.from("sale_items").insert(
    saleItems.map(i => ({
      sale_id: saleId, item_name: i.item_title,
      quantity: i.quantity, price: i.price, subtotal: i.subtotal
    }))
  );
  if (itemsError) return alert("Error saving items!");

  // Update stock
  const promises = [];
  saleItems.forEach(i => {
    if (i.book_id) {
      promises.push(supabase.rpc("decrement_book_stock", { p_book_id: parseInt(i.book_id), p_decrement_by: i.quantity }));
    }
  });
  await Promise.all(promises);

  // Refresh local stocks
  const { data: newBooks } = await supabase.from("books").select("*");
  if (newBooks) newBooks.forEach(b => bookStock[b.id] = b.quantity);

  // Print receipt
  printReceipt(saleId, studentName, studentClass, saleItems, totalAmount);

  // Reset
  cartTableBody.innerHTML = "";
  recalcTotal();
  saleForm.reset();
});

function printReceipt(saleId, studentName, studentClass, saleItems, totalAmount, cashierFirstName = "", cashierLastName = "") {
  const win = window.open('', '', 'width=600,height=800');
  const date = new Date().toLocaleString();
  // ‚úÖ Auto-detect term based on current month
const currentMonth = new Date().getMonth() + 1; // getMonth() is 0-indexed (0=Jan, 11=Dec)

let term;
if (currentMonth >= 9 && currentMonth <= 12) {
  term = "Term 1"; // Sept (9) - Dec (12)
} else if (currentMonth >= 1 && currentMonth <= 4) {
  term = "Term 2"; // Jan (1) - Apr (4)
} else if (currentMonth >= 5 && currentMonth <= 8) {
  term = "Term 3"; // May (5) - Aug (8)
}
  let html = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Receipt</title>
      <style>
        body {
          font-family: 'Courier New', monospace;
          margin: 20px;
          padding: 0;
          font-size: 14px;
          line-height: 1.4;
        }
        .header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 15px;
          width: 100%;
        }
        .school-info {
          text-align: left;
          font-size: 16px;
          font-weight: bold;
        }
        .receipt-id {
          font-size: 14px;
          margin-top: 5px;
          font-weight: normal;
        }
        .right-column {
          text-align: right;
          font-size: 14px;
          margin-left: auto;
          margin-right: 0;
        }
        .student-info {
          text-align: center;
          margin: 10px 0;
          font-size: 14px;
        }
        table {
          width: 100%;
          border-collapse: collapse;
          margin: 15px 0;
          font-size: 14px;
          text-align: center;
        }
        th, td {
          border: 1px solid #000;
          padding: 8px;
        }
        th {
          background-color: #f5f5f5;
          font-weight: bold;
        }
        .total-row {
          font-weight: bold;
          text-align: right;
          padding: 8px;
          margin-top: 10px;
          border-top: 2px dashed #000;
        }
       .footer {
  margin-top: 40px;
  display: flex;
  justify-content: space-between;
  font-size: 14px;
}
        @media print {
          body { padding: 10px; }
        }
      </style>
    </head>
    <body>

      <!-- Header Row -->
      <!-- Header Row -->
<!-- Header Row -->
<!-- Header Row -->
<div class="header">
  <div style="flex-shrink: 0; padding-right: 15px;"> <!-- üëà Space added here -->
    <img 
      id="receipt-logo" 
      src="https://uyqpvhcjsflogujbfheu.supabase.co/storage/v1/object/public/image/logo.jpeg" 
      alt="Royal Charisma School Logo"
      style="width: 90px; height: 90px; object-fit: contain;"
      onerror="this.outerHTML = '<div style=&quot;width:90px;height:90px;background:#f9f9f9;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#aaa;border:1px dashed #ccc;&quot;>RC</div>';"
    />
  </div>
  <div class="school-info">
    Royal Charisma School<br>
    Atadeka<br>
    0244985338 / 0244754611<br>
    <span class="receipt-id">${saleId}</span>
  </div>
  <div class="right-column">
    Date: ${date}<br>
    Term: ${term}
  </div>
</div>


      <!-- Student Info -->
      <div class="student-info">
        Name: ${studentName} &nbsp;&nbsp;&nbsp;&nbsp;
        Class: ${studentClass}
      </div>

      <!-- Items Table -->
      <table>
        <thead>
          <tr>
            <th>Book Name</th>
            <th>Qty</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>`;
  
  saleItems.forEach(i => {
    html += `<tr>
      <td>${i.item_title}</td>
      <td>${i.quantity}</td>
      <td>‚Çµ${i.subtotal.toFixed(2)}</td>
    </tr>`;
  });

  html += `</tbody>
      </table>

      <!-- Grand Total -->
      <div class="total-row">
        Grand Total: ‚Çµ${totalAmount.toFixed(2)}
      </div>

<!-- Footer -->
<div class="footer">
  <span class="cashier" style="margin-right: auto;">
    Cashier: ${cashierFirstName} ${cashierLastName}
  </span>
  <span class="signature" style="margin-left: auto;">
    <strong>Signature:</strong>&nbsp;
    <span style="border-bottom: 1px solid #000; width: 140px; display: inline-block; padding: 2px 0; text-align: center;">
      ____________________
    </span>
  </span>
</div>

    </body>
    </html>`;

    win.document.write(html);
win.document.close();

// Wait for logo image to load
const img = win.document.getElementById('receipt-logo');

if (img) {
  img.onload = function() {
    // Image loaded ‚Äî safe to print
    win.print();
    win.close();
  };
  img.onerror = function() {
    // Image failed ‚Äî print anyway (fallback already handled by onerror)
    win.print();
    win.close();
  };
} else {
  // No image found ‚Äî print immediately
  win.print();
  win.close();
}
}
// ‚úÖ Fetch and display dashboard stats
async function loadDashboardStats() {
  const todayStart = new Date();
  todayStart.setHours(0, 0, 0, 0); // Start of today
  const todayEnd = new Date();
  todayEnd.setHours(23, 59, 59, 999); // End of today

  try {
    // 1. Fetch today's sales
    const { data: sales, error: salesError } = await supabase
      .from('sales')
      .select('id, total, student_name') // ‚úÖ Matches your table
      .gte('created_at', todayStart.toISOString())
      .lte('created_at', todayEnd.toISOString());

    if (salesError) throw salesError;

    const saleIds = sales.map(s => s.id);

    // 2. Books Sold Today (sum of quantities from sale_items)
    let booksSold = 0;
    if (saleIds.length > 0) {
      const { data: saleItems, error: itemsError } = await supabase
        .from('sale_items')
        .select('quantity')
        .in('sale_id', saleIds);

      if (itemsError) throw itemsError;
      booksSold = saleItems.reduce((sum, item) => sum + item.quantity, 0);
    }

    // 3. Students Served Today (count distinct student_name)
    const studentNames = [...new Set(sales.map(s => s.student_name))];
    const studentsServed = studentNames.length;

    // 4. Sales Today (sum of total)
    const salesToday = sales.reduce((sum, sale) => sum + sale.total, 0);

    // 5. Low Stock Count (books with quantity <= 5)
    // 5. Low Stock Books (quantity <= 5)
const { data: lowStockBooks, error: lowStockError } = await supabase
  .from('books')
  .select('title, quantity')
  .lte('quantity', 5)
  .order('quantity', { ascending: true });

if (lowStockError) throw lowStockError;

// Update UI
const lowStockContainer = document.getElementById('lowStockList');
if (lowStockBooks.length === 0) {
  lowStockContainer.textContent = "All good üëç (no low stock)";
} else {
  lowStockContainer.innerHTML = lowStockBooks
    .map(book => `<div>${book.title} (${book.quantity} left)</div>`)
    .join('');
}

    // ‚úÖ Update UI
    document.getElementById('booksSold').textContent = booksSold;
    document.getElementById('studentsServed').textContent = studentsServed;
    document.getElementById('salesToday').textContent = `‚Çµ${salesToday.toFixed(2)}`;
    //document.getElementById('lowStockCount').textContent = lowStock || 0;

  } catch (err) {
    console.error("Error loading dashboard stats:", err.message || err);
  }
}


  // Load stats when page loads
  loadDashboardStats();

// Optional: Auto-refresh every 30 seconds
setInterval(loadDashboardStats, 30000);

// Listen for new sales
const salesChannel = supabase
  .channel('new-sales')
  .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'sales' }, () => {
    loadDashboardStats(); // Re-fetch all stats
  })
  .subscribe();

// Also listen for stock changes (if books are restocked or sold out)
const booksChannel = supabase
  .channel('book-stock-changes')
  .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'books' }, () => {
    loadDashboardStats(); // Update low stock count
  })
  .subscribe();


// ‚úÖ Load recent transactions (last 10)
async function loadRecentTransactions() {
  try {
    // 1. Fetch last 10 sales
    const { data: sales, error: salesError } = await supabase
      .from('sales')
      .select('id, student_name, student_class, total, created_at')
      .order('created_at', { ascending: false })
      .limit(10);

    if (salesError) {
      console.error("‚ùå Sales query failed:", salesError.message);
      throw salesError;
    }

    if (!sales || sales.length === 0) {
      document.getElementById('transactionTable').innerHTML = `
        <tr><td colspan="5" class="text-center text-muted">No transactions yet</td></tr>
      `;
      window.allTransactions = [];
      return;
    }

    // 2. Enrich each sale with its items
    const enrichedSales = [];
    for (const sale of sales) {
      const { data: items, error: itemsError } = await supabase
        .from('sale_items')
        .select('item_name, quantity')
        .eq('sale_id', sale.id);

      if (itemsError) {
        console.error(`‚ö†Ô∏è Error fetching items for sale_id ${sale.id}:`, itemsError.message);
        sale.books = "‚Äî";
      } else if (!items || items.length === 0) {
        sale.books = "‚Äî";
      } else {
        sale.books = items.map(i => `${i.item_name} (x${i.quantity})`).join(', ');
      }

      enrichedSales.push(sale);
    }
    

    // 3. Store globally + display
    window.allTransactions = enrichedSales;
    displayTransactions(enrichedSales);

  } catch (err) {
    console.error("üí• Full error in loadRecentTransactions:", err);
    document.getElementById('transactionTable').innerHTML = `
      <tr>
        <td colspan="5" class="text-center text-danger">
          Failed to load transactions. Check console for details.
        </td>
      </tr>
    `;
  }
}
document.addEventListener('click', async (e) => {
  const button = e.target.closest('.js-reprint');
  if (!button) return;

  const saleIdStr = button.getAttribute('data-sale-id');
  if (!saleIdStr) {
    console.error("‚ùå Print button missing data-sale-id");
    return;
  }

  // ‚úÖ VALIDATE UUID FORMAT
  const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
  if (!uuidRegex.test(saleIdStr)) {
    console.error("‚ùå Invalid UUID format:", saleIdStr);
    alert("Invalid transaction ID. Please refresh the page.");
    return;
  }

  button.disabled = true;
  button.textContent = 'Printing...';

  try {
    await reprintTransaction(saleIdStr); // ‚úÖ Pass the raw UUID string
  } catch (err) {
    console.error("üí• Error during reprint:", err);
    alert("Failed to reprint receipt. Check console.");
  } finally {
    button.disabled = false;
    button.textContent = 'üñ® Print';
  }
});
// ‚úÖ GLOBAL FUNCTION ‚Äî ONLY ONE INSTANCE ‚Äî OUTSIDE ALL OTHER FUNCTIONS
async function reprintTransaction(saleId) {
  try {
    // Fetch sale info
    const { data: sale, error: saleError } = await supabase
      .from("sales")
      .select("id, student_name, student_class, total, created_at, cashier_first_name, cashier_last_name")
      .eq("id", saleId)
      .single();

    if (saleError) throw saleError;

    // Fetch sale items
    const { data: items, error: itemsError } = await supabase
      .from("sale_items")
      .select("item_name, quantity, subtotal")
      .eq("sale_id", saleId);

    if (itemsError) throw itemsError;

    // Transform to match printReceipt expectations
    const saleItems = items.map(i => ({
      item_title: i.item_name,
      quantity: i.quantity,
      subtotal: i.subtotal ?? 0
    }));

    // Call existing printReceipt
    printReceipt(
      sale.id,
      sale.student_name,
      sale.student_class,
      saleItems,
      sale.total,
      sale.cashier_first_name || "",
      sale.cashier_last_name || ""
    );

  } catch (err) {
    console.error("‚ùå Error reprinting receipt:", err.message || err);
    alert("Failed to reprint receipt. Check console.");
  }
}


// ‚úÖ Search transactions by student name ‚Äî CLEAN, NO NESTED FUNCTIONS
document.getElementById('studentSearch').addEventListener('input', function(e) {
  const searchTerm = e.target.value.toLowerCase().trim();
  
  if (!window.allTransactions) return;

  const filtered = window.allTransactions.filter(sale => 
    sale.student_name.toLowerCase().includes(searchTerm)
  );

  displayTransactions(filtered);
});
// ‚úÖ ‚úÖ ‚úÖ DEFINITION OF displayTransactions ‚Äî MUST BE HERE!
function displayTransactions(transactions) {
  const table = document.getElementById("transactionTable");

  if (transactions.length === 0) {
    table.innerHTML = `
      <tr>
        <td colspan="6" class="text-center text-muted">No transactions found</td>
      </tr>
    `;
    return;
  }

  table.innerHTML = transactions.map(t => {
    if (!t.id || typeof t.id !== 'string' || t.id.trim() === '') {
      console.warn("‚ö†Ô∏è Invalid transaction ID:", t);
      return `<tr><td colspan="6" class="text-center text-danger">Invalid transaction data</td></tr>`;
    }

    const saleId = t.id; // Keep as string ‚Äî DO NOT PARSE
    return `
      <tr>
        <td>${t.student_name}</td>
        <td>${t.student_class}</td>
        <td>${t.books}</td>
        <td>‚Çµ${t.total.toFixed(2)}</td>
        <td>${new Date(t.created_at).toLocaleDateString()}</td>
        <td>
          <button 
            class="btn btn-sm btn-outline-primary js-reprint" 
            data-sale-id="${saleId}"
          >
            üñ® Print
          </button>
        </td>
      </tr>
    `;
  }).join("");
}


// Load transactions when page loads
loadRecentTransactions();


// Listen for new sales
// Listen for new sales
const newSalesChannel = supabase
  .channel('new-sales-realtime')
  .on(
    'postgres_changes',
    { event: 'INSERT', schema: 'public', table: 'sales' },
    () => {
      loadRecentTransactions();
      loadDashboardStats(); // üëà optional: refresh stats as well
    }
  )
  .subscribe();

// Prevent closing with ESC
window.addEventListener("keydown", (e) => {
  if (e.key === "Escape") e.preventDefault();
});

// Prevent closing by clicking outside
modal.addEventListener("click", (e) => {
  if (e.target === modal) e.stopPropagation();
});

</script>   
<!-- Force Password Change Modal -->
<div id="passwordModal" class="modal">
  <div class="modal-content">
    <h2>Change Your Password</h2>
    <p>You must change your password before continuing.</p>
    <input type="password" id="newPassword" placeholder="New Password" required />
    <input type="password" id="confirmPassword" placeholder="Confirm Password" required />
    <button id="changePasswordBtn">Change Password</button>
    <div id="statusMessage"></div>
  </div>
</div>

</body>
</html>
