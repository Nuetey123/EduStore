<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduStore Cashier Login</title>
  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/sales-login.css">
</head>
<body>
  <div class="login-container">
    <div class="login-card">
      <div class="logo">💼</div>
      <h1>Login Page</h1>
      <p>Quick access to EduStore system</p>

      <form id="loginForm">
        <label for="email">Email</label>
        <input type="email" id="email" placeholder="Email" required />

        <label for="password">Password</label>
        <input type="password" id="password" placeholder="Password" required />

        <button type="submit">Login</button>
      </form>

      <div id="statusMessage" class="status-message" role="status" aria-live="polite"></div>

      <div class="footer">© 2025 EduStore. All rights reserved.</div>
    </div>
  </div>

  <!-- Clean Supabase script -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://uyqpvhcjsflogujbfheu.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV5cXB2aGNqc2Zsb2d1amJmaGV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5MTQ4NzQsImV4cCI6MjA3MjQ5MDg3NH0.Yn75_sNjk8-bZhvFRyGZML3rLWro0W4tsBXhdcE6aDA";
    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const form = document.getElementById("loginForm");
    const statusEl = document.getElementById("statusMessage");
    const submitBtn = form.querySelector('button[type="submit"]');

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();

      statusEl.textContent = "Logging in...";
      statusEl.style.color = "blue";
      submitBtn.disabled = true;

      try {
        // sign in
        const { data, error } = await client.auth.signInWithPassword({
          email,
          password,
        });
        if (error) throw error;

        // first try to use returned user
        let user = data?.user ?? null;

        // if user is not present for some reason, fetch it explicitly
        if (!user) {
          const { data: userData, error: getUserError } = await client.auth.getUser();
          if (getUserError) throw getUserError;
          user = userData?.user ?? null;
        }

        if (!user) {
          throw new Error("Unable to retrieve user after login.");
        }

        // role can be in user_metadata or app_metadata
        const role = user?.user_metadata?.role || user?.app_metadata?.role;
        const mustChangePassword = !!(user?.user_metadata?.must_change_password);

        // route users based on role and must-change flag
        if (role === 'admin') {
          window.location.href = 'admin-dashboard.html';
        } else if (role === 'cashier') {
          if (mustChangePassword) {
            // make sure change-password page uses the active session (see note below)
            window.location.href = 'change-password.html';
          } else {
            window.location.href = 'sales-dashboard.html';
          }
        } else {
          // fallback: either no role or unknown role
          statusEl.textContent = "❌ Unauthorized role. Contact administrator.";
          statusEl.style.color = "red";
          // sign out to clear any session
          await client.auth.signOut();
        }

      } catch (err) {
        console.error("Login failed:", err);
        // Friendly error messages
        let message = "❌ Invalid email or password.";
        if (err?.status === 429) message = "❌ Too many attempts. Try again later.";
        if (err?.message?.toLowerCase().includes('password')) {
          // leave as-is, don't leak details
          message = err.message;
        }
        statusEl.textContent = message;
        statusEl.style.color = "red";
      } finally {
        submitBtn.disabled = false;
      }
    });

    // Optional: Prevent back navigation abuse after logout
    if (window.history.length > 1) {
      window.history.pushState(null, null, window.location.href);
      window.addEventListener('popstate', () => {
        window.history.pushState(null, null, window.location.href);
      });
    }
  </script>
</body>
</html>
