<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EduStore | Stock Viewer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .sidebar { width: 250px; background: #f8f9fa; padding: 20px; height: 100vh; position: fixed; }
    main { margin-left: 250px; padding: 20px; }
    .card { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .stat-box { background: #e9ecef; padding: 10px 15px; border-radius: 5px; text-align: center; }
    .stat-value { font-size: 1.5em; font-weight: bold; color: #495057; }
    .low-stock { color: #e74c3c; font-weight: 600; }
  </style>
</head>
<body>
<div class="d-flex">
  <!-- Sidebar -->
  <aside class="sidebar">
    <h2 class="mb-4">EduStore Admin</h2>
    <nav class="nav flex-column">
      <a href="admin-dashboard.html" class="nav-link">üè† Dashboard</a>
      <a href="inventory.html" class="nav-link">üì¶ Inventory</a>
      <a href="sales-viewer.html" class="nav-link">üíµ Sales Viewer</a>
      <a href="#" class="nav-link">‚öôÔ∏è Settings</a>
       <a href="#" id="logoutBtn">üö™ Logout</a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="flex-grow-1">
    <header class="topbar mb-4">
      <h1 class="h4">üìä Book Stock Overview</h1>
    </header>

    <div class="container-fluid">
      <!-- Stats Row -->
      <div class="row mb-4" id="statsContainer"></div>

      <!-- Stock Table -->
      <section class="card p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="h5 mb-0">üìö Current Stock</h2>
          <button class="btn btn-secondary btn-sm" onclick="loadBooks()">üîÑ Refresh</button>
        </div>
        <div class="table-responsive">
          <table class="table table-striped align-middle" id="booksTable">
            <thead class="table-dark">
              <tr>
                <th>Title</th>
                <th>Initial Stock</th>
                <th>Restocked</th>
                <th>Sold</th>
                <th>Current Stock</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="booksTableBody">
              <tr><td colspan="6" class="text-center">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>
  </main>
</div>

<!-- Supabase & App JS -->


<script  type="module">

import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  const supabaseUrl = 'https://uyqpvhcjsflogujbfheu.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV5cXB2aGNqc2Zsb2d1amJmaGV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5MTQ4NzQsImV4cCI6MjA3MjQ5MDg3NH0.Yn75_sNjk8-bZhvFRyGZML3rLWro0W4tsBXhdcE6aDA';

  // ‚úÖ USE THIS EXACT LINE ‚Äî CAPITAL 'S' IN SupabaseClient
  const supabase = createClient(supabaseUrl, supabaseKey);
  window.supabase = supabase; 

  document.addEventListener('DOMContentLoaded', loadBooks);

  function renderBooks(books) {
    const tbody = document.getElementById('booksTableBody');
    tbody.innerHTML = books.map(book => {
      const totalEverAdded = book.initial_stock + book.total_restocked;
      const totalReturned = book.total_returned || 0;
      const currentStock = book.quantity;
      const totalSold = totalEverAdded - currentStock;
      const isLowStock = currentStock <= 5;

      return `
        <tr>
          <td><strong>${book.title}</strong></td>
          <td>${book.initial_stock}</td>
          <td>+${book.total_restocked}</td>
          <td>${totalSold}</td>
          <td ${isLowStock ? 'class="low-stock"' : ''}>
            ${currentStock} ${isLowStock ? '‚ö†Ô∏è' : ''}
          </td>
          <td>${book.status}</td>
        </tr>
      `;
    }).join("");
  }

  function renderStats(books) {
    const container = document.getElementById('statsContainer');
    const totalTitles = books.length;
    const totalInitial = books.reduce((sum, b) => sum + b.initial_stock, 0);
    const totalRestocked = books.reduce((sum, b) => sum + b.total_restocked, 0);
    const totalReturned = books.reduce((sum, b) => sum + (b.total_returned || 0), 0);
    const totalCurrent = books.reduce((sum, b) => sum + b.quantity, 0);
    const totalSold = totalInitial + totalRestocked - totalReturned - totalCurrent;

    container.innerHTML = `
      <div class="col-md-2 stat-box">
        <div>Total Titles</div>
        <div class="stat-value">${totalTitles}</div>
      </div>
      <div class="col-md-2 stat-box">
        <div>Initial Stock</div>
        <div class="stat-value">${totalInitial}</div>
      </div>
      <div class="col-md-2 stat-box">
        <div>Restocked</div>
        <div class="stat-value">+${totalRestocked}</div>
      </div>
      <div class="col-md-2 stat-box">
        <div>Returned</div>
        <div class="stat-value">+${totalReturned}</div>
      </div>
      <div class="col-md-2 stat-box">
        <div>Sold</div>
        <div class="stat-value">${totalSold}</div>
      </div>
      <div class="col-md-2 stat-box">
        <div>Current Stock</div>
        <div class="stat-value">${totalCurrent}</div>
      </div>
    `;
  }

  async function loadBooks() {
    const tbody = document.getElementById('booksTableBody');
    tbody.innerHTML = '<tr><td colspan="6" class="text-center">Loading...</td></tr>';

    try {
      const { data: books, error } = await supabase
        .from('books')
        .select('id, title, quantity, initial_stock, total_restocked, total_returned, status')
        .order('title', { ascending: true });

      if (error) throw error;
      if (!books || books.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">üì≠ No books found.</td></tr>';
        return;
      }

      renderBooks(books);
      renderStats(books);
    } catch (err) {
      console.error("üí• ERROR loading books:", err.message);
      tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">‚ùå Failed to load stock data: ${err.message}</td></tr>`;
    }
  }

  // ----------------- Logout Functionality -----------------
  document.getElementById("logoutBtn").addEventListener("click", async (e) => {
    e.preventDefault();

    if (!confirm("Are you sure you want to log out?")) {
      return;
    }

    const statusEl = document.createElement("div");
    statusEl.className = "alert alert-info fixed-top text-center m-0 rounded-0";
    statusEl.textContent = "Signing out...";
    document.body.appendChild(statusEl);

    try {
      const { error } = await supabase.auth.signOut();
      
      if (error) {
        throw error;
      }

      localStorage.removeItem("lastUsedBookId");
      sessionStorage.clear();
      window.location.href = "sales-login.html";

    } catch (err) {
      console.error("Logout failed:", err);
      statusEl.className = "alert alert-danger fixed-top text-center m-0 rounded-0";
      statusEl.textContent = "‚ùå Failed to sign out. Try again.";
      setTimeout(() => {
        document.body.removeChild(statusEl);
      }, 3000);
    } finally {
      setTimeout(() => {
        if (statusEl.parentNode) {
          document.body.removeChild(statusEl);
        }
      }, 2000);
    }
  });
</script>
</body>
</html>
