<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduStore | Change Password</title>
  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/change-password.css">
</head>
<body>
  <div class="change-password-container">
    <div class="change-password-card">
      <h1>Set Your Password</h1>
      <p>You‚Äôve been invited to join EduStore. Please create a strong password.</p>

    <form id="changePasswordForm">
  <label for="newPassword">New Password *</label>
  <div style="position: relative;">
    <input type="password" id="newPassword" placeholder="password" required minlength="6" style="padding-right:35px;">
    <span id="toggleNew" 
          style="position:absolute; right:10px; top:50%; transform:translateY(-50%);
                 cursor:pointer; font-size:18px; user-select:none;">üëÅÔ∏è</span>
  </div>

  <label for="confirmPassword">Confirm New Password *</label>
  <div style="position: relative;">
    <input type="password" id="confirmPassword" placeholder="password" required style="padding-right:35px;">
    <span id="toggleConfirm" 
          style="position:absolute; right:10px; top:50%; transform:translateY(-50%);
                 cursor:pointer; font-size:18px; user-select:none;">üëÅÔ∏è</span>
  </div>

  <!-- ‚úÖ Add back the submit button -->
  <button type="submit" style="margin-top:15px; width:100%;">Update Password</button>
</form>

<!-- This div should remain outside the form -->
<div id="statusMessage" class="status-message"></div>




  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

 <script>
  const SUPABASE_URL = 'https://uyqpvhcjsflogujbfheu.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV5cXB2aGNqc2Zsb2d1amJmaGV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5MTQ4NzQsImV4cCI6MjA3MjQ5MDg3NH0.Yn75_sNjk8-bZhvFRyGZML3rLWro0W4tsBXhdcE6aDA';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const form = document.getElementById('changePasswordForm');
  const statusEl = document.getElementById('statusMessage');

  async function verifyLoggedIn() {
    const { data: { user }, error } = await supabase.auth.getUser();
    if (error || !user) {
      statusEl.textContent = '‚ùå You must be logged in to set your password.';
      statusEl.style.color = 'red';
      setTimeout(() => {
        window.location.href = 'sales-login.html';
      }, 2500);
      return false;
    }
    return true;
  }

  verifyLoggedIn();

  form.addEventListener('submit', async function(e) {
    e.preventDefault();

    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    if (newPassword !== confirmPassword) {
      statusEl.textContent = '‚ùå Passwords do not match!';
      statusEl.style.color = 'red';
      return;
    }

    if (newPassword.length < 6) {
      statusEl.textContent = '‚ùå Password must be at least 6 characters long.';
      statusEl.style.color = 'red';
      return;
    }

    statusEl.textContent = 'Updating password...';
    statusEl.style.color = 'blue';

    try {
      // üîë Update password
      const { error: pwdError } = await supabase.auth.updateUser({ password: newPassword });
      if (pwdError) throw pwdError;

      // üîë Safely update metadata (clear must_change_password)
      const { data: { user } } = await supabase.auth.getUser();
      const newMeta = { ...user.user_metadata, must_change_password: false };
      await supabase.auth.updateUser({ data: newMeta });

      statusEl.textContent = '‚úÖ Password updated successfully! Redirecting to dashboard...';
      statusEl.style.color = 'green';

      setTimeout(() => {
        window.location.href = 'sales-dashboard.html';
      }, 2000);

    } catch (err) {
      console.error('Password update failed:', err);
      let message = '‚ùå Failed to update password. Try again.';
      if (err.message?.includes('weak_password')) {
        message = '‚ùå Password too weak. Use at least 6 characters with letters and numbers.';
      }
      statusEl.textContent = message;
      statusEl.style.color = 'red';
    }
  });

    // üëÅÔ∏è Show/hide password toggle
  const newPwInput = document.getElementById('newPassword');
  const confirmPwInput = document.getElementById('confirmPassword');
  const toggleNew = document.getElementById('toggleNew');
  const toggleConfirm = document.getElementById('toggleConfirm');

  function toggleVisibility(input, btn) {
    if (input.type === "password") {
      input.type = "text";
      btn.textContent = "üôà"; 
    } else {
      input.type = "password";
      btn.textContent = "üëÅÔ∏è"; 
    }
  }

  toggleNew.addEventListener('click', () => toggleVisibility(newPwInput, toggleNew));
  toggleConfirm.addEventListener('click', () => toggleVisibility(confirmPwInput, toggleConfirm));
</script>

</body>
</html>