<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduStore | Change Password</title>
  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/change-password.css">
</head>
<body>
  <div class="change-password-container">
    <div class="change-password-card">
      <h1>Set Your Password</h1>
      <p>You‚Äôve been invited to join EduStore. Please create a strong password.</p>

      <form id="changePasswordForm">
        <label for="newPassword">New Password *</label>
        <input type="password" id="newPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="8">

        <label for="confirmPassword">Confirm New Password *</label>
        <input type="password" id="confirmPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>

        <button type="submit">Update Password</button>
      </form>

      <div id="statusMessage" class="status-message"></div>
    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <script>
    // üîê Clean Supabase config (no extra spaces)
    const SUPABASE_URL = 'https://uyqpvhcjsflogujbfheu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV5cXB2aGNqc2Zsb2d1amJmaGV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5MTQ4NzQsImV4cCI6MjA3MjQ5MDg3NH0.Yn75_sNjk8-bZhvFRyGZML3rLWro0W4tsBXhdcE6aDA';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const form = document.getElementById('changePasswordForm');
    const statusEl = document.getElementById('statusMessage');

    // ‚úÖ Verify user is logged in (since this is for first-login flow)
    async function verifyLoggedIn() {
      const { data: { user }, error } = await supabase.auth.getUser();
      if (error || !user) {
        statusEl.textContent = '‚ùå You must be logged in to set your password.';
        statusEl.style.color = 'red';
        setTimeout(() => {
          window.location.href = 'sales-login.html';
        }, 2500);
        return false;
      }
      return true;
    }

    // Run on page load
    verifyLoggedIn();

    // ‚úÖ Handle form submission
    form.addEventListener('submit', async function(e) {
      e.preventDefault();

      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      if (newPassword !== confirmPassword) {
        statusEl.textContent = '‚ùå Passwords do not match!';
        statusEl.style.color = 'red';
        return;
      }

      if (newPassword.length < 8) {
        statusEl.textContent = '‚ùå Password must be at least 8 characters long.';
        statusEl.style.color = 'red';
        return;
      }

      statusEl.textContent = 'Updating password...';
      statusEl.style.color = 'blue';

      try {
        // Update password (user is already authenticated)
        const { error: pwdError } = await supabase.auth.updateUser({ password: newPassword });
        if (pwdError) throw pwdError;

        // Clear the must_change_password flag
        const { error: metaError } = await supabase.auth.updateUser({
          data: { must_change_password: false }
        });
        if (metaError) {
          console.warn('Warning: Could not clear must_change_password flag:', metaError);
        }

        statusEl.textContent = '‚úÖ Password updated successfully! Redirecting to dashboard...';
        statusEl.style.color = 'green';

        setTimeout(() => {
          window.location.href = 'sales-dashboard.html';
        }, 2000);

      } catch (err) {
        console.error('Password update failed:', err);
        let message = '‚ùå Failed to update password. Try again.';
        if (err.message?.includes('weak_password')) {
          message = '‚ùå Password too weak. Use at least 8 characters with letters and numbers.';
        }
        statusEl.textContent = message;
        statusEl.style.color = 'red';
      }
    });
  </script>
</body>
</html>