<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduStore | Change Password</title>
  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/change-password.css">
</head>
<body>
  <div class="change-password-container">
    <div class="change-password-card">
      <h1>Set Your Password</h1>
      <p>You‚Äôve been invited to join EduStore. Please create a strong password.</p>

      <form id="changePasswordForm">
        <label for="newPassword">New Password *</label>
        <input type="password" id="newPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>

        <label for="confirmPassword">Confirm New Password *</label>
        <input type="password" id="confirmPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>

        <button type="submit">Update Password</button>
      </form>

      <div id="statusMessage" class="status-message"></div>
    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <script>
    // üîê YOUR SUPABASE CREDENTIALS
    const SUPABASE_URL = 'https://uyqpvhcjsflogujbfheu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV5cXB2aGNqc2Zsb2d1amJmaGV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5MTQ4NzQsImV4cCI6MjA3MjQ5MDg3NH0.Yn75_sNjk8-bZhvFRyGZML3rLWro0W4tsBXhdcE6aDA';

    const supabase = window.SupabaseClient.createClient(SUPABASE_URL, SUPABASE_KEY);

    const form = document.getElementById('changePasswordForm');
    const statusEl = document.getElementById('statusMessage');

    // üëá EXTRACT TOKENS FROM URL HASH (magic link)
    const urlParams = new URLSearchParams(window.location.hash.substring(1));
    const accessToken = urlParams.get('access_token');
    const refreshToken = urlParams.get('refresh_token');

    // ‚ùå If no tokens, invalid or expired link
    if (!accessToken || !refreshToken) {
      statusEl.textContent = '‚ùå Invalid or expired link. Please request a new invitation.';
      statusEl.style.color = 'red';
      setTimeout(() => {
        window.location.href = '../register-sales.html'; // Back to registration
      }, 3000);
      return;
    }

    // ‚úÖ FORM SUBMISSION
    form.addEventListener('submit', async function(e) {
      e.preventDefault();

      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      // Validate passwords match
      if (newPassword !== confirmPassword) {
        statusEl.textContent = '‚ùå Passwords do not match!';
        statusEl.style.color = 'red';
        return;
      }

      // Validate password strength
      if (newPassword.length < 8) {
        statusEl.textContent = '‚ùå Password must be at least 8 characters long.';
        statusEl.style.color = 'red';
        return;
      }

      statusEl.textContent = 'Updating password...';
      statusEl.style.color = 'blue';

      try {
        // ‚úÖ STEP 1: Log in using the magic link tokens (temporary session)
        const { data, error } = await supabase.auth.setSession({
          access_token: accessToken,
          refresh_token: refreshToken
        });

        if (error) throw error;

        // ‚úÖ STEP 2: Update the user's password
        const { data: updateData, error: updateError } = await supabase.auth.updateUser({
          password: newPassword
        });

        if (updateError) throw updateError;

        // ‚úÖ SUCCESS!
        statusEl.textContent = '‚úÖ Password updated successfully! Redirecting to login...';
        statusEl.style.color = 'green';

        // Wait 2 seconds then redirect to login
        setTimeout(() => {
          window.location.href = 'http://localhost:5500/pages/sales-login.html';
        }, 2000);

      } catch (err) {
        console.error("Password update failed:", err);
        
        let message = '‚ùå Failed to update password. Try again.';
        if (err.message.includes('weak_password')) {
          message = '‚ùå Password too weak.';
        }
        
        statusEl.textContent = message;
        statusEl.style.color = 'red';
      }
    });
  </script>
</body>
</html>